when:
  - event: ["push", "pull_request"]
    branch: ["main"]

engine: nixery

dependencies:
  nixpkgs:
    - shell
    - stdenv
    - findutils
    - binutils
    - libunwind
    - ncurses
    - opam
    - git
    - gawk
    - gnupatch
    - gnum4
    - gnumake
    - gnutar
    - gnused
    - gnugrep
    - diffutils
    - gzip
    - bzip2
    - gcc
    - ocaml

steps:
  - name: opam
    command: |
       opam init --disable-sandboxing -a -y
  - name: switch
    command: |
       opam install . --confirm-level=unsafe-yes --deps-only
  - name: build
    command: |
       opam exec -- dune build
  - name: switch-test
    command: |
       opam install . --confirm-level=unsafe-yes --deps-only --with-test
  - name: test
    command: |
       opam exec -- dune runtest --verbose
  - name: doc
    command: |
       opam install -y odoc
       opam exec -- dune build @doc
